use wasm_bindgen::prelude::*;
use tables::tables::*;

mod tables;

#[wasm_bindgen]
pub fn number() -> f64 {
    let a = [[1.0, 2.0, 3.0]];
    let b = [[5.0, 6.0, 7.0], [8., 9., 10.], [11., 12., 13.]];
    let c = dot(&a, &b);
    c[0][0]
}

fn wavelength_to_rgb(&weights: &[f64; 38]) -> [f64; 3] {
    let mut average_xyz = [0., 0., 0.];
    for i in 0..WL_TO_XYZ.len() {
        for j in 0..3 {
            average_xyz[j] += WL_TO_XYZ[i][j] * weights[i];
        }
    }
    for i in 0..3 {
        average_xyz[i] *= CHROMA_ADJUST[i] * 28.3333333;
    }
    dot(&[average_xyz], &XYZ_TO_RGB)[0]
}

fn dot(a: &[[f64; 3]; 1], b: &[[f64; 3]; 3]) -> [[f64; 3]; 1] {
    let mut c = [[0., 0., 0.]];
    for i in 0..a.len() {
        for j in 0..b[0].len() {
            for k in 0..b.len() {
                c[i][j] += a[i][k] * b[k][j];
            }
        }
    }
    c
}

#[cfg(test)]
mod tests {
    use super::*;
    #[test]
    fn test_dot() {
        let a = [[1., 2., 3.]];
        let b = [[4., 5., 6.], [7., 8., 9.], [10., 11., 12.]];
        let c = dot(&a, &b);
        assert_eq!(c, [[48., 54., 60.]]);
    }
    #[test]
    fn test_wavelength_to_rgb() {
        let testReflectance = [
            0.024397921682939597, 0.031688527788324386, 0.04072236273852973,
            0.04651743351449017, 0.04601290651923267, 0.0499356927452353,
            0.0667534544126962, 0.07697197304088868, 0.07190212194810658,
            0.0608319050156441, 0.04385939136847545, 0.027181263228923776,
            0.014494429987760382, 0.007899000456711562, 0.004800710374541182,
            0.0039007677509941634, 0.003999913462343323, 0.0038997353132813363,
            0.003800393304437832, 0.00429892056978943, 0.005095387923533669,
            0.005985172383253364, 0.007045256460008371, 0.008321795816795345,
            0.009880196202950369, 0.011043173626857456, 0.012173357637494012,
            0.013190239396028133, 0.013009155760964597, 0.0127797934864742,
            0.012365016876425038, 0.012924477576550394, 0.013909444949959795,
            0.01695382464313897, 0.020986765314007807, 0.024790270153378608,
            0.030147645844814365, 0.040403876231291574,
        ];
        assert_eq!(wavelength_to_rgb(&testReflectance), [2.0086507993906846, 0.8559391227860728, 19.903537616668157])
    }
}
